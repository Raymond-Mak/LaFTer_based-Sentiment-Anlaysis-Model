## 模型基本架构
采用了多任务深度学习框架，核心思想是同时优化两个任务：

1. **情感分类任务** - 预测图像的主要情感类别
2. **分布预测任务** - 预测图像在所有情感类别上的概率分布

### 训练流程详解


#### 2. 损失函数设计

模型使用了一个加权组合的损失函数：

```
L = (1 - λ)Lcls(x, y) + λLsdl(x, l)
```

其中：

- **Lcls** 是标准的softmax分类损失
- **Lsdl** 是情感分布学习损失（使用KL散度）
- **λ** 是权重参数，控制两种损失的平衡

## 分布学习的具体实现

#### 对于有分布标注的数据集：

直接使用多个标注者的投票结果作为真实分布。例如，如果11个人标注一张图片，其中5人标注为"快乐"，3人标注为"惊讶"，3人标注为"满足"，那么真实分布就是 [5/11, 3/11, 3/11, 0, ...]

#### 对于单标签数据集：

论文提出了两种策略来生成分布：

**策略1 - 基于蕴含关系（Implication）：** 使用高斯函数根据情感之间的距离生成分布：

```
f(i, μ, σ) = (1/√(2πσ)) * exp(-|i-μ|²/2σ²) + ε/C
```

- μ 是主导情感标签
- σ 控制分布的扩散程度
- 距离基于Mikels情感轮盘计算

**策略2 - 基于排斥关系（Exclusion）：** 只给同极性（正面或负面）的情感分配概率：

- 如果主导情感是正面的，只有正面情感有非零概率
- 如果主导情感是负面的，只有负面情感有非零概率

#### 训练过程优化

训练时使用随机梯度下降（SGD），梯度计算公式为：

```
∂L/∂a = p - (1-λ)y - λl
```

这个公式巧妙地将分类任务和分布预测任务的梯度结合在一起：

- 当λ=0时，退化为纯分类任务
- 当λ=1时，变为纯分布预测任务
- 实验表明λ=0.8时效果最佳

#### 训练细节

- **批次大小**：32
- **数据划分**：80%训练，5%验证，15%测试

#### 分布学习的核心创新

这个模型的关键创新在于：

1. **利用标签歧义性**：不是简单地将图像分配给单一情感，而是学习情感的概率分布
2. **多任务学习**：分类和分布预测相互促进，提高了特征学习的鲁棒性
3. **弱监督扩展**：即使只有单标签数据，也能通过先验知识生成合理的分布

这种方法让模型能够更好地捕捉图像情感的复杂性和主观性，因为一张图片确实可能唤起多种情感反应。

## 损失函数构建过程

####  总体损失函数设计

作者将两个任务的损失函数通过加权组合的方式构建总损失：

```
L = (1 - λ)L_cls(x, y) + λL_sdl(x, l)
```

其中：

- `L_cls(x, y)` 是分类损失
- `L_sdl(x, l)` 是情感分布学习损失
- `λ` 是权重参数，控制两个任务的平衡

#### 2.2 分类损失函数 L_cls

采用标准的**Softmax交叉熵损失**：

```
L_cls(x, y) = -1/N ∑_{i=1}^N ∑_{j=1}^C 1(y^(i) = j) ln p_j^(i)
```

其中：

- `N` 是训练样本数
- `C` 是情感类别数
- `1(y^(i) = j)` 是指示函数，当样本i的真实标签为j时为1，否则为0
- `p_j^(i)` 是样本i被预测为类别j的概率

概率计算通过Softmax函数：

```
p_j^(i) = exp(a_j^(i)) / ∑_{k=1}^C exp(a_k^(i))
```

####  情感分布学习损失 L_sdl

采用**Kullback-Leibler (KL)散度**来衡量预测分布与真实分布的相似性：

```
L_sdl(x, l) = -1/N ∑_{i=1}^N ∑_{j=1}^C l_j^(i) ln p_j^(i)
```

其中：

- `l_j^(i)` 是样本i在情感类别j上的真实分布值
- 这个损失函数实际上是预测分布与真实分布之间的交叉熵

#### 梯度推导过程

该文章使用了SDG来优化损失函数。
作者详细推导了损失函数对激活值的梯度：

```
∂L/∂a_j^(i) = (1-λ)[p_j^(i) ∑_k y_k^(i) - y_j^(i)] + λ[p_j^(i) ∑_k l_k^(i) - l_j^(i)]
             = p_j^(i) - (1-λ)y_j^(i) - λl_j^(i)
```

这个梯度公式很有启发性：

- 当λ=0时，退化为标准分类损失的梯度
- 当λ=1时，完全是分布学习损失的梯度
- 中间值时，是两者的加权组合